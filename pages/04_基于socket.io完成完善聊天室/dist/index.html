<!DOCTYPE html>
<html lang="zh">

<head>
  <meta charset="UTF-8">
  <title>聊天室</title>
  <link rel="stylesheet" href="./css/style.css">
</head>

<body>

  <div class="login-wrap">
    <div class="content">
      <h3 class="title">昵称</h3>
      <input class="username-input" type="text" />
      <div class="login-btn">进入聊天室</div>
    </div>
  </div>

  <div class="chat-wrap hidden">
    <div class="content">
      <div class="nav">
        <p>今日话题 (Github：coder-belong)</p>
        <p>今年打算跳槽吗？</p>
      </div>
      <div class="chat-list-content">123</div>
      <div class="send-message-wrap">
        <input type="text" class="message-input" placeholder="输入消息" />
        <div class="send-btn">发送</div>
      </div>
    </div>

  </div>

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
  <script>
    const socket = io('http://localhost:4003');

    $('.username-input').focus();

    // 监听进入聊天室按钮的点击
    $('.login-btn').on('click', () => {
      // 获取用户名输入框的值
      const usernameVal = $('.username-input').val().trim();
      if (usernameVal) {
        // 向服务器发送 join 事件，并携带用户名信息
        socket.emit('join', usernameVal);
        // 隐藏登陆页面，显示聊天页面
        $('.login-wrap').addClass('hidden');
        $('.chat-wrap').removeClass('hidden');
        // 清空输入框
        $('.username-input').val('');
      }
    });

    // 监听发送消息按钮的点击
    $(".send-btn").on("click", () => {
      const messageVal = $(".message-input").val().trim();
      if (messageVal) {
        // 向服务器发送 chatMessage 事件，并携带消息内容
        socket.emit('chatMessage', messageVal);
        // 清空输入框
        $(".message-input").val('');
      }
    })

    // 监听服务端发送的 userJoined 事件
    socket.on('userJoined', (username) => {
      const messageElement = $('<div></div>')
        .text(`${username} 加入了聊天室`)
        .addClass('log');
      $('.chat-list-content').append(messageElement);
    });

    // 监听服务端发送的 userLeft 事件
    socket.on('userLeft', (username) => {
      const messageElement = $('<div></div>')
        .text(`${username} 离开了聊天室`)
        .addClass('log');
      $('#messages').append(messageElement);
    });

    // 监听服务端发送的 message 事件
    socket.on('chatMessage', (data) => {
      const messageElement = document.createElement('div');
      messageElement.textContent = `${data.user} [${data.time}]: ${data.text}`;
      messageElement.classList.add('message');
      if (data.user === socket.id) {
        messageElement.classList.add('my-message');
      } else {
        messageElement.classList.add('other-message');
      }
      document.getElementById('messages').appendChild(messageElement);
      document.getElementById('messages').scrollTop = document.getElementById('messages').scrollHeight;
    });


  </script>
</body>

</html>